"use strict";function __extends(t,i){function e(){this.constructor=t}extendStatics(t,i),t.prototype=null===i?Object.create(i):(e.prototype=i.prototype,new e)}Object.defineProperty(exports,"__esModule",{value:!0});var Rectangle=function(){function t(t,i,e,h,r,n){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),void 0===h&&(h=0),void 0===r&&(r=!1),void 0===n&&(n=void 0),this.oversized=!1,this._rot=!1,this._allowRotation=void 0,this._dirty=0,this._width=t,this._height=i,this._x=e,this._y=h,this._data={},this._rot=r,this._allowRotation=n}return t.Collide=function(t,i){return t.collide(i)},t.Contain=function(t,i){return t.contain(i)},t.prototype.area=function(){return this.width*this.height},t.prototype.collide=function(t){return t.x<this.x+this.width&&t.x+t.width>this.x&&t.y<this.y+this.height&&t.y+t.height>this.y},t.prototype.contain=function(t){return t.x>=this.x&&t.y>=this.y&&t.x+t.width<=this.x+this.width&&t.y+t.height<=this.y+this.height},Object.defineProperty(t.prototype,"width",{get:function(){return this._width},set:function(t){t!==this._width&&(this._width=t,this._dirty++)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},set:function(t){t!==this._height&&(this._height=t,this._dirty++)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._x},set:function(t){t!==this._x&&(this._x=t,this._dirty++)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._y},set:function(t){t!==this._y&&(this._y=t,this._dirty++)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rot",{get:function(){return this._rot},set:function(t){if(!1!==this._allowRotation&&this._rot!==t){var i=this.width;this.width=this.height,this.height=i,this._rot=t,this._dirty++}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"allowRotation",{get:function(){return this._allowRotation},set:function(t){this._allowRotation!==t&&(this._allowRotation=t,this._dirty++)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"data",{get:function(){return this._data},set:function(t){null!==t&&t!==this._data&&(this._data=t,"object"==typeof t&&t.hasOwnProperty("allowRotation")&&(this._allowRotation=t.allowRotation),this._dirty++)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dirty",{get:function(){return this._dirty>0},enumerable:!0,configurable:!0}),t.prototype.setDirty=function(t){void 0===t&&(t=!0),this._dirty=t?this._dirty+1:0},t}(),extendStatics=function(t,i){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])})(t,i)},__assign=function(){return(__assign=Object.assign||function(t){for(var i,e=1,h=arguments.length;e<h;e++){i=arguments[e];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])}return t}).apply(this,arguments)},Bin=function(){function t(){this._dirty=0}return Object.defineProperty(t.prototype,"dirty",{get:function(){return this._dirty>0||this.rects.some(function(t){return t.dirty})},enumerable:!0,configurable:!0}),t.prototype.setDirty=function(t){if(void 0===t&&(t=!0),this._dirty=t?this._dirty+1:0,!t)for(var i=0,e=this.rects;i<e.length;i++){var h=e[i];h.setDirty&&h.setDirty(!1)}},t}(),MaxRectsBin=function(t){function i(i,e,h,r){void 0===i&&(i=EDGE_MAX_VALUE),void 0===e&&(e=EDGE_MAX_VALUE),void 0===h&&(h=0),void 0===r&&(r={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,border:0,logic:exports.PACKING_LOGIC.MAX_EDGE});var n=t.call(this)||this;return n.maxWidth=i,n.maxHeight=e,n.padding=h,n.options=r,n.freeRects=[],n.rects=[],n.verticalExpand=!1,n.width=n.options.smart?0:i,n.height=n.options.smart?0:e,n.border=n.options.border?n.options.border:0,n.freeRects.push(new Rectangle(n.maxWidth+n.padding-2*n.border,n.maxHeight+n.padding-2*n.border,n.border,n.border)),n.stage=new Rectangle(n.width,n.height),n}return __extends(i,t),i.prototype.add=function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];var e,h;if(1===t.length){if("object"!=typeof t[0])throw new Error("MacrectsBin.add(): Wrong parameters");var r=(h=t[0]).data&&h.data.tag?h.data.tag:h.tag?h.tag:void 0;if(this.options.tag&&this.tag!==r)return}else{if(e=t.length>2?t[2]:null,this.options.tag){if(e&&this.tag!==e.tag)return;if(!e&&this.tag)return}(h=new Rectangle(t[0],t[1])).data=e,h.setDirty(!1)}var n=this.place(h);return n&&this.rects.push(n),n},i.prototype.repack=function(){var t=[];this.reset(),this.rects.sort(function(t,i){var e=Math.max(i.width,i.height)-Math.max(t.width,t.height);return 0===e&&t.hash&&i.hash?t.hash>i.hash?-1:1:e});for(var i=0,e=this.rects;i<e.length;i++){n=e[i];this.place(n)||t.push(n)}for(var h=0,r=t;h<r.length;h++){var n=r[h];this.rects.splice(this.rects.indexOf(n),1)}return t.length>0?t:void 0},i.prototype.reset=function(t,i){void 0===t&&(t=!1),void 0===i&&(i=!1),t&&(this.data&&delete this.data,this.tag&&delete this.tag,this.rects=[],i&&(this.options={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,border:0})),this.width=this.options.smart?0:this.maxWidth,this.height=this.options.smart?0:this.maxHeight,this.border=this.options.border?this.options.border:0,this.freeRects=[new Rectangle(this.maxWidth+this.padding-2*this.border,this.maxHeight+this.padding-2*this.border,this.border,this.border)],this.stage=new Rectangle(this.width,this.height),this._dirty=0},i.prototype.place=function(t){var i=t.data&&t.data.tag?t.data.tag:t.tag?t.tag:void 0;if(!this.options.tag||this.tag===i){var e,h;if(h=t.hasOwnProperty("_allowRotation")&&void 0!==t.allowRotation?t.allowRotation:this.options.allowRotation,e=this.findNode(t.width+this.padding,t.height+this.padding,h)){this.updateBinSize(e);for(var r=this.freeRects.length,n=0;n<r;)this.splitNode(this.freeRects[n],e)&&(this.freeRects.splice(n,1),r--,n--),n++;return this.pruneFreeList(),this.verticalExpand=this.width>this.height,t.x=e.x,t.y=e.y,void 0===t.rot&&(t.rot=!1),t.rot=e.rot?!t.rot:t.rot,this._dirty++,t}if(this.verticalExpand){if(this.updateBinSize(new Rectangle(t.width+this.padding,t.height+this.padding,this.border,this.height+this.padding-this.border))||this.updateBinSize(new Rectangle(t.width+this.padding,t.height+this.padding,this.width+this.padding-this.border,this.border)))return this.place(t)}else if(this.updateBinSize(new Rectangle(t.width+this.padding,t.height+this.padding,this.width+this.padding-this.border,this.border))||this.updateBinSize(new Rectangle(t.width+this.padding,t.height+this.padding,this.border,this.height+this.padding-this.border)))return this.place(t)}},i.prototype.findNode=function(t,i,e){var h,r,n,s=Number.MAX_VALUE;for(var o in this.freeRects)(r=this.freeRects[o]).width>=t&&r.height>=i&&(h=this.options.logic===exports.PACKING_LOGIC.MAX_AREA?r.width*r.height-t*i:Math.min(r.width-t,r.height-i))<s&&(n=new Rectangle(t,i,r.x,r.y),s=h),e&&r.width>=i&&r.height>=t&&(h=this.options.logic===exports.PACKING_LOGIC.MAX_AREA?r.width*r.height-i*t:Math.min(r.height-t,r.width-i))<s&&(n=new Rectangle(i,t,r.x,r.y,!0),s=h);return n},i.prototype.splitNode=function(t,i){if(!t.collide(i))return!1;if(i.x<t.x+t.width&&i.x+i.width>t.x){if(i.y>t.y&&i.y<t.y+t.height){e=new Rectangle(t.width,i.y-t.y,t.x,t.y);this.freeRects.push(e)}if(i.y+i.height<t.y+t.height){e=new Rectangle(t.width,t.y+t.height-(i.y+i.height),t.x,i.y+i.height);this.freeRects.push(e)}}if(i.y<t.y+t.height&&i.y+i.height>t.y){if(i.x>t.x&&i.x<t.x+t.width){e=new Rectangle(i.x-t.x,t.height,t.x,t.y);this.freeRects.push(e)}if(i.x+i.width<t.x+t.width){var e=new Rectangle(t.x+t.width-(i.x+i.width),t.height,i.x+i.width,t.y);this.freeRects.push(e)}}return!0},i.prototype.pruneFreeList=function(){for(var t=0,i=0,e=this.freeRects.length;t<e;){i=t+1;for(var h=this.freeRects[t];i<e;){var r=this.freeRects[i];if(r.contain(h)){this.freeRects.splice(t,1),t--,e--;break}h.contain(r)&&(this.freeRects.splice(i,1),i--,e--),i++}t++}},i.prototype.updateBinSize=function(t){if(!this.options.smart)return!1;if(this.stage.contain(t))return!1;var i=Math.max(this.width,t.x+t.width-this.padding+this.border),e=Math.max(this.height,t.y+t.height-this.padding+this.border);if(this.options.allowRotation){var h=Math.max(this.width,t.x+t.height-this.padding+this.border),r=Math.max(this.height,t.y+t.width-this.padding+this.border);h*r<i*e&&(i=h,e=r)}return this.options.pot&&(i=Math.pow(2,Math.ceil(Math.log(i)*Math.LOG2E)),e=Math.pow(2,Math.ceil(Math.log(e)*Math.LOG2E))),this.options.square&&(i=e=Math.max(i,e)),!(i>this.maxWidth+this.padding||e>this.maxHeight+this.padding)&&(this.expandFreeRects(i+this.padding,e+this.padding),this.width=this.stage.width=i,this.height=this.stage.height=e,!0)},i.prototype.expandFreeRects=function(t,i){var e=this;this.freeRects.forEach(function(h,r){h.x+h.width>=Math.min(e.width+e.padding-e.border,t)&&(h.width=t-h.x-e.border),h.y+h.height>=Math.min(e.height+e.padding-e.border,i)&&(h.height=i-h.y-e.border)},this),this.freeRects.push(new Rectangle(t-this.width-this.padding,i-2*this.border,this.width+this.padding-this.border,this.border)),this.freeRects.push(new Rectangle(t-2*this.border,i-this.height-this.padding,this.border,this.height+this.padding-this.border)),this.freeRects=this.freeRects.filter(function(t){return!(t.width<=0||t.height<=0||t.x<e.border||t.y<e.border)}),this.pruneFreeList()},i}(Bin),OversizedElementBin=function(t){function i(){for(var i=[],e=0;e<arguments.length;e++)i[e]=arguments[e];var h=t.call(this)||this;if(h.rects=[],1===i.length){if("object"!=typeof i[0])throw new Error("OversizedElementBin: Wrong parameters");var r=i[0];h.rects=[r],h.width=r.width,h.height=r.height,h.data=r.data,r.oversized=!0}else h.width=i[0],h.height=i[1],h.data=i.length>2?i[2]:null,(r=new Rectangle(h.width,h.height)).oversized=!0,r.data=h.data,h.rects.push(r);return h.freeRects=[],h.maxWidth=h.width,h.maxHeight=h.height,h.options={smart:!1,pot:!1,square:!1},h}return __extends(i,t),i.prototype.add=function(){},i.prototype.reset=function(t){},i.prototype.repack=function(){},i}(Bin),EDGE_MAX_VALUE=4096;!function(t){t[t.MAX_AREA=0]="MAX_AREA",t[t.MAX_EDGE=1]="MAX_EDGE"}(exports.PACKING_LOGIC||(exports.PACKING_LOGIC={}));var MaxRectsPacker=function(){function t(t,i,e,h){void 0===t&&(t=EDGE_MAX_VALUE),void 0===i&&(i=EDGE_MAX_VALUE),void 0===e&&(e=0),void 0===h&&(h={smart:!0,pot:!0,square:!1,allowRotation:!1,tag:!1,border:0,logic:exports.PACKING_LOGIC.MAX_EDGE}),this.width=t,this.height=i,this.padding=e,this.options=h,this._currentBinIndex=0,this.bins=[]}return t.prototype.add=function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];if(1===t.length){if("object"!=typeof t[0])throw new Error("MacrectsPacker.add(): Wrong parameters");var e=t[0];if(e.width>this.width||e.height>this.height)this.bins.push(new OversizedElementBin(e));else if(!(s=this.bins.slice(this._currentBinIndex).find(function(t){return void 0!==t.add(e)}))){var h=new MaxRectsBin(this.width,this.height,this.padding,this.options),r=e.data&&e.data.tag?e.data.tag:e.tag?e.tag:void 0;this.options.tag&&r&&(h.tag=r),h.add(e),this.bins.push(h)}return e}var n=new Rectangle(t[0],t[1]);if(t.length>2&&(n.data=t[2]),n.width>this.width||n.height>this.height)this.bins.push(new OversizedElementBin(n));else{var s=this.bins.slice(this._currentBinIndex).find(function(t){return void 0!==t.add(n)});if(!s){h=new MaxRectsBin(this.width,this.height,this.padding,this.options);this.options.tag&&n.data.tag&&(h.tag=n.data.tag),h.add(n),this.bins.push(h)}}return n},t.prototype.addArray=function(t){var i=this;this.sort(t,this.options.logic).forEach(function(t){return i.add(t)})},t.prototype.reset=function(){this.bins=[],this._currentBinIndex=0},t.prototype.repack=function(t){if(void 0===t&&(t=!0),t){for(var i=[],e=0,h=this.bins;e<h.length;e++){var r=h[e];if(r.dirty){var n=r.repack();n&&i.push.apply(i,n)}}return void this.addArray(i)}if(this.dirty){var s=this.rects;this.reset(),this.addArray(s)}},t.prototype.next=function(){return this._currentBinIndex=this.bins.length,this._currentBinIndex},t.prototype.load=function(t){var i=this;t.forEach(function(t,e){if(t.maxWidth>i.width||t.maxHeight>i.height)i.bins.push(new OversizedElementBin(t.width,t.height,{}));else{var h=new MaxRectsBin(i.width,i.height,i.padding,t.options);h.freeRects.splice(0),t.freeRects.forEach(function(t,i){h.freeRects.push(new Rectangle(t.width,t.height,t.x,t.y))}),h.width=t.width,h.height=t.height,t.tag&&(h.tag=t.tag),i.bins[e]=h}},this)},t.prototype.save=function(){var t=[];return this.bins.forEach(function(i){var e={width:i.width,height:i.height,maxWidth:i.maxWidth,maxHeight:i.maxHeight,freeRects:[],rects:[],options:i.options};i.tag&&(e=__assign(__assign({},e),{tag:i.tag})),i.freeRects.forEach(function(t){e.freeRects.push({x:t.x,y:t.y,width:t.width,height:t.height})}),t.push(e)}),t},t.prototype.sort=function(t,i){return void 0===i&&(i=exports.PACKING_LOGIC.MAX_EDGE),t.slice().sort(function(t,e){var h=i===exports.PACKING_LOGIC.MAX_EDGE?Math.max(e.width,e.height)-Math.max(t.width,t.height):e.width*e.height-t.width*t.height;return 0===h&&t.hash&&e.hash?t.hash>e.hash?-1:1:h})},Object.defineProperty(t.prototype,"currentBinIndex",{get:function(){return this._currentBinIndex},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dirty",{get:function(){return this.bins.some(function(t){return t.dirty})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rects",{get:function(){for(var t=[],i=0,e=this.bins;i<e.length;i++){var h=e[i];t.push.apply(t,h.rects)}return t},enumerable:!0,configurable:!0}),t}();exports.Bin=Bin,exports.MaxRectsBin=MaxRectsBin,exports.MaxRectsPacker=MaxRectsPacker,exports.OversizedElementBin=OversizedElementBin,exports.Rectangle=Rectangle;
